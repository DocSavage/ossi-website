---
import "../../styles/tailwind.css";
import { siteConfig } from "../../siteConfig";
import { getCollection } from "astro:content";

import BaseLayout from "../../layouts/BaseLayout.astro";
import CardsAndFiltersIsland from "../../components/projects/CardsAndFiltersIsland";
import Hero from "../../components/Hero.jsx";
import CardContainer from "../../components/projects/CardContainer";
import CardContent from "../../components/projects/CardContent.astro";
import CardImage from "../../components/projects/CardImage";
import FilterMenu from "../../components/projects/FilterMenu";
import ResetProjectTypeBtn from "../../components/projects/ResetProjectTypeBtn";
import ProjectCount from "../../components/projects/ProjectCount";
import ProjectTypeBtns from "../../components/projects/ProjectTypeBtns";
import ProjectTypeDropdown from "../../components/projects/ProjectTypeDropdown";
import Tag from "../../components/projects/Tag.astro";
import ToggleFilterMenuBtn from "../../components/projects/ToggleFilterMenuBtn";

import { extractUniqueTagsObject } from "../../utils/tagManipulation.js";

const baseUrl = import.meta.env.BASE_URL;

const pageTitle = "OSSI-supported projects";
const allProjects = await getCollection("projects");

// uniqueTags is an object where keys = unique tag categories, values = unique tags within a category, both across allProjects. All lowercase.
// used to populate the filter menu
const uniqueTags = extractUniqueTagsObject(allProjects);
---

<BaseLayout pageTitle={pageTitle}>
  <Hero
    client:load
    baseUrl={baseUrl}
    title=`${siteConfig.shortName} Software Projects`
    subtitle=`${siteConfig.name} (${siteConfig.acronymOnly}) supported software projects and other software developed at Janelia`
    heightClasses="h-96 py-20 2xl:pt-36"
    alignmentClasses="2xl:flex-col 2xl:items-start"
  />
  <CardsAndFiltersIsland contentType="projects" client:load>
    <FilterMenu uniqueTags={uniqueTags} slot="filterMenu" client:only />

    <ProjectTypeBtns slot="projectTypeBtns" client:visible />

    <ResetProjectTypeBtn slot="resetProjectTypeBtn" client:load />
    <ProjectTypeDropdown slot="projecTypeDropdown" client:visible />

    <ToggleFilterMenuBtn
      slot="toggleFilterMenuBtn"
      uniqueTags={uniqueTags}
      client:visible
    />

    <ProjectCount
      slot="projectCount"
      allContent={allProjects}
      contentType="projects"
      client:load
    />
    <Fragment slot="contentCards">
      {
        allProjects.map((content) => {
          const tagsObj = extractUniqueTagsObject(content);
          // console.log("tagsObj", tagsObj);
          return (
            <CardContainer
              key={content.slug}
              baseUrl={baseUrl}
              url={`${baseUrl}/projects/${content.slug}/`}
              title={content.data.title}
              authors={content.data["author names"]}
              tagline={content.data.tagline}
              imageSrc={content.data["image file"]}
              imageAlt={content.data["image alt text"]}
              tagsObj={tagsObj}
              projectType={content.data["project type"][0]}
              client:only
            >
              {content.data["image file"] ? (
                <img
                  src={`${baseUrl}/project-images/${content.data["image file"]}`}
                  class="w-full h-40 object-cover object-center"
                  loading="lazy"
                  slot="cardImage"
                />
              ) : (
                <CardImage slot="cardImage" client:load />
              )}

              <CardContent
                title={content.data.title}
                authors={content.data["author names"]}
                tagline={content.data.tagline}
                tagsObj={tagsObj}
                slot="cardContent"
              />
              <Fragment slot="tags">
                {Object.entries(tagsObj).map(([tagCat, tags]) => {
                  // console.log(tags);
                  return tags.map((tag) => {
                    return (
                      <Tag tagCat={tagCat} tag={tag} contentType="projects" />
                    );
                  });
                })}
              </Fragment>
            </CardContainer>
          );
        })
      }
    </Fragment>
  </CardsAndFiltersIsland></BaseLayout
>
